<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è¦–ç‡å ±è¡¨è‡ªå‹•å½™æ•´</title>
    <!-- å¼•å…¥å¤–éƒ¨ SheetJS è™•ç† Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #16a34a;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
        }
        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 800px;
            text-align: center;
            margin-bottom: 20px;
        }
        h1 { color: #1e293b; margin-bottom: 0.5rem; font-size: 1.5rem; }
        p.desc { color: #64748b; font-size: 0.9rem; margin-bottom: 1.5rem; }
        
        .drop-zone {
            border: 2px dashed #cbd5e1;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drop-zone:hover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            flex: 1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 200px;
        }
        #processBtn { background-color: var(--primary-color); }
        #downloadBtn { background-color: var(--success-color); display: none; }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; }

        #fileList {
            margin-top: 1rem;
            text-align: left;
            font-size: 0.85rem;
            color: #475569;
            max-height: 100px;
            overflow-y: auto;
            border-top: 1px solid #f1f5f9;
            padding-top: 10px;
        }
        
        .preview-container {
            background: white;
            width: 100%;
            max-width: 1200px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            display: none;
        }
        .preview-header {
            background: #f1f5f9;
            padding: 10px 20px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.8rem;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap;
        }
        tr:nth-child(even) { background-color: #f8fafc; }
        tr:nth-child(-n+22) { background-color: #fff7ed; } 

        #status { margin-top: 1rem; font-weight: bold; }
        .success { color: var(--success-color); }
        .error { color: #dc2626; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“ˆ æ”¶è¦–ç‡å ±è¡¨å½™æ•´</h1>
    <p class="desc">
        ä¿ç•™é¦–æª”å‰ 22 åˆ—è¨­å®šè³‡è¨Šï¼Œæ•¸æ“šå°‡ä¾æ™‚æ®µæ¨™ç±¤åˆ‡å‰²ä¸¦ä¸‹è¼‰å¤šå€‹æª”æ¡ˆ
    </p>
    
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <p>é»æ“Šé¸å–å¤šå€‹ Excel æª”æ¡ˆ</p>
        <input type="file" id="fileInput" multiple accept=".xlsx, .xls" style="display:none">
        <div id="fileList"></div>
    </div>

    <div class="button-group">
        <button id="processBtn" disabled>1. å½™æ•´ã€æ’åºä¸¦é è¦½</button>
        <button id="downloadBtn">2. ä¸‹è¼‰æ™‚æ®µå‘½åæª”æ¡ˆ</button>
    </div>
    <div id="status"></div>
</div>

<div class="preview-container" id="previewContainer">
    <div class="preview-header">
        <span>å½™æ•´é è¦½ (é¡¯ç¤ºåˆä½µå¾Œçš„è³‡æ–™)</span>
    </div>
    <div class="table-wrapper">
        <table id="previewTable"></table>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusDiv = document.getElementById('status');
    const fileListDiv = document.getElementById('fileList');
    const previewContainer = document.getElementById('previewContainer');
    const previewTable = document.getElementById('previewTable');

    // å®šç¾©æ™‚æ®µåŠå…¶å°æ‡‰åç¨±
    const timeSlots = [
        { label: "æ™¨é–“", start: "07:00:00", end: "08:59:59" },
        { label: "9é»", start: "09:00:00", end: "09:59:59" },
        { label: "10é»", start: "10:00:00", end: "10:59:59" },
        { label: "11é»", start: "11:00:00", end: "11:59:59" },
        { label: "åˆé–“", start: "11:55:00", end: "13:59:59" },
        { label: "14é»", start: "14:00:00", end: "14:59:59" },
        { label: "15é»", start: "15:00:00", end: "15:59:59" },
        { label: "16é»", start: "16:00:00", end: "16:59:59" },
        { label: "17é»", start: "17:00:00", end: "17:59:59" },
        { label: "æ™šé–“", start: "17:55:00", end: "19:59:59" },
        { label: "å¤œé–“", start: "21:55:00", end: "23:59:59" }
    ];

    let globalHeader = [];
    let globalBody = [];

    fileInput.addEventListener('change', () => {
        fileListDiv.innerHTML = '';
        previewContainer.style.display = 'none';
        downloadBtn.style.display = 'none';
        if (fileInput.files.length > 0) {
            processBtn.disabled = false;
            Array.from(fileInput.files).forEach(file => {
                const div = document.createElement('div');
                div.textContent = `ğŸ“„ ${file.name}`;
                fileListDiv.appendChild(div);
            });
        } else {
            processBtn.disabled = true;
        }
    });

    processBtn.addEventListener('click', async () => {
        const files = fileInput.files;
        statusDiv.innerHTML = 'â³ è™•ç†ä¸­...';
        processBtn.disabled = true;

        try {
            globalHeader = [];
            globalBody = [];

            for (let i = 0; i < files.length; i++) {
                const data = await readExcelData(files[i]);
                if (i === 0) {
                    globalHeader = data.slice(0, 22);
                    if (data.length > 22) globalBody = data.slice(22);
                } else {
                    if (data.length > 22) globalBody = globalBody.concat(data.slice(22));
                }
            }

            // ä¾æ™‚é–“æ’åº (å‡è¨­æ™‚é–“åœ¨ç¬¬ä¸€æ¬„ Column A)
            globalBody.sort((a, b) => {
                const valA = a[0] ? String(a[0]) : "";
                const valB = b[0] ? String(b[0]) : "";
                return valA.localeCompare(valB, undefined, {numeric: true});
            });

            renderPreview(globalHeader.concat(globalBody.slice(0, 1000)));
            
            statusDiv.className = 'success';
            statusDiv.innerHTML = `âœ… å½™æ•´å®Œæˆï¼å…± ${files.length} å€‹æª”æ¡ˆã€‚è«‹é»æ“Šä¸‹è¼‰åˆ†æ™‚æ®µå ±è¡¨ã€‚`;
            downloadBtn.style.display = 'block';
            previewContainer.style.display = 'block';
        } catch (error) {
            console.error(error);
            statusDiv.className = 'error';
            statusDiv.innerHTML = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€‚';
        } finally {
            processBtn.disabled = false;
        }
    });

    downloadBtn.addEventListener('click', async () => {
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, "");
        let downloadCount = 0;

        for (const slot of timeSlots) {
            // ç¯©é¸å‡ºç¬¦åˆè©²æ™‚æ®µçš„æ•¸æ“š
            const filteredBody = globalBody.filter(row => {
                const time = String(row[0]); 
                return time >= slot.start && time <= slot.end;
            });

            // å¦‚æœè©²æ™‚æ®µæ²’è³‡æ–™å‰‡è·³é
            if (filteredBody.length === 0) continue;

            const finalOutput = globalHeader.concat(filteredBody);
            const ws = XLSX.utils.aoa_to_sheet(finalOutput);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, slot.label);

            const timeRange = `${slot.start.replace(/:/g,"")}-${slot.end.replace(/:/g,"")}`;
            const fileName = `${dateStr} ${slot.label}1åˆ†é˜.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            downloadCount++;
            
            // å»¶é² 300ms é¿å…è§¸ç™¼ç€è¦½å™¨ä¸‹è¼‰é˜»æ“‹æˆ–ä½µç™¼éŒ¯èª¤
            await new Promise(r => setTimeout(r, 300));
        }
        statusDiv.innerHTML = `âœ… å·²å˜—è©¦ä¸‹è¼‰ ${downloadCount} å€‹æ™‚æ®µæª”æ¡ˆã€‚`;
    });

    function renderPreview(data) {
        previewTable.innerHTML = '';
        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            row.slice(0, 10).forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell !== undefined ? cell : "";
                tr.appendChild(td);
            });
            previewTable.appendChild(tr);
        });
    }

    function readExcelData(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    resolve(XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" }));
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }
</script>

</body>
</html>
