<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è¦–ç‡å ±è¡¨è‡ªå‹•å½™æ•´å·¥å…· (æ”¯æ´1/2åˆ†é˜è¾¨è­˜)</title>
    <!-- å¼•å…¥å¤–éƒ¨ SheetJS è™•ç† Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #16a34a;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
        }
        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 800px;
            text-align: center;
            margin-bottom: 20px;
        }
        h1 { color: #1e293b; margin-bottom: 0.5rem; font-size: 1.5rem; }
        p.desc { color: #64748b; font-size: 0.9rem; margin-bottom: 1.5rem; }
        
        .drop-zone {
            border: 2px dashed #cbd5e1;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drop-zone:hover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            flex: 1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 200px;
        }
        #processBtn { background-color: var(--primary-color); }
        #downloadBtn { background-color: var(--success-color); display: none; }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; }

        #fileList {
            margin-top: 1rem;
            text-align: left;
            font-size: 0.85rem;
            color: #475569;
            max-height: 100px;
            overflow-y: auto;
            border-top: 1px solid #f1f5f9;
            padding-top: 10px;
        }
        
        .preview-container {
            background: white;
            width: 100%;
            max-width: 1200px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            display: none;
            margin-top: 20px;
        }
        .preview-header {
            background: #f1f5f9;
            padding: 10px 20px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.8rem;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap;
        }
        tr:nth-child(even) { background-color: #f8fafc; }
        .header-row { background-color: #fff7ed !important; }
        .date-col { color: var(--primary-color); font-weight: bold; background-color: #f0f7ff; }

        #status { margin-top: 1rem; font-weight: bold; }
        .success { color: var(--success-color); }
        .error { color: #dc2626; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“ˆ æ”¶è¦–ç‡å ±è¡¨å½™æ•´</h1>
    <p class="desc">
        æ”¯æ´<strong>1åˆ†é˜èˆ‡2åˆ†é˜</strong>å ±è¡¨è‡ªå‹•è¾¨è­˜ã€‚ä¸åŒæ—¥æœŸå°‡æ‹†åˆ†ç‚ºåˆ†é ï¼Œæª”æ¡ˆåç¨±ä¸å«å¹´ä»½ã€‚
    </p>
    
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <p>é»æ“Šæˆ–æ‹–æ›³é¸å–å¤šå€‹ Excel æª”æ¡ˆ</p>
        <input type="file" id="fileInput" multiple accept=".xlsx, .xls" style="display:none">
        <div id="fileList"></div>
    </div>

    <div class="button-group">
        <button id="processBtn" disabled>1. å½™æ•´è³‡æ–™ä¸¦é è¦½</button>
        <button id="downloadBtn">2. ä¸‹è¼‰åˆ†æ™‚æ®µå ±è¡¨ (è‡ªå‹•å€åˆ†1/2åˆ†é˜)</button>
    </div>
    <div id="status"></div>
</div>

<div class="preview-container" id="previewContainer">
    <div class="preview-header">
        <span>å½™æ•´é è¦½ (æ—¥æœŸèˆ‡é–“éš”æ¨™è¨»æ–¼é¦–æ¬„)</span>
    </div>
    <div class="table-wrapper">
        <table id="previewTable"></table>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusDiv = document.getElementById('status');
    const fileListDiv = document.getElementById('fileList');
    const previewContainer = document.getElementById('previewContainer');
    const previewTable = document.getElementById('previewTable');

    const timeSlots = [
        { label: "æ™¨é–“", start: "07:00:00", end: "08:59:59" },
        { label: "9é»", start: "09:00:00", end: "09:59:59" },
        { label: "10é»", start: "10:00:00", end: "10:59:59" },
        { label: "11é»", start: "11:00:00", end: "11:59:59" },
        { label: "åˆé–“", start: "11:55:00", end: "13:59:59" },
        { label: "14é»", start: "14:00:00", end: "14:59:59" },
        { label: "15é»", start: "15:00:00", end: "15:59:59" },
        { label: "16é»", start: "16:00:00", end: "16:59:59" },
        { label: "17é»", start: "17:00:00", end: "17:59:59" },
        { label: "æ™šé–“", start: "17:55:00", end: "19:59:59" },
        { label: "å¤œé–“", start: "21:55:00", end: "23:59:59" }
    ];

    let globalHeader = [];
    let globalBodyWithDate = [];

    fileInput.addEventListener('change', () => {
        fileListDiv.innerHTML = '';
        previewContainer.style.display = 'none';
        downloadBtn.style.display = 'none';
        statusDiv.innerHTML = '';
        if (fileInput.files.length > 0) {
            processBtn.disabled = false;
            Array.from(fileInput.files).forEach(file => {
                const div = document.createElement('div');
                div.textContent = `ğŸ“„ ${file.name}`;
                fileListDiv.appendChild(div);
            });
        } else {
            processBtn.disabled = true;
        }
    });

    // è¾¨è­˜è³‡æ–™é–“éš” (1åˆ†é˜æˆ–2åˆ†é˜)
    function detectInterval(rows) {
        if (rows.length < 2) return 1;
        const t1 = rows[0][0];
        const t2 = rows[1][0];
        if (!t1 || !t2) return 1;
        
        const parseToSec = (str) => {
            const p = String(str).split(':');
            return p.length >= 2 ? parseInt(p[0]) * 3600 + parseInt(p[1]) * 60 + (parseInt(p[2]) || 0) : 0;
        };
        
        const diff = Math.abs(parseToSec(t2) - parseToSec(t1));
        return (diff >= 110 && diff <= 130) ? 2 : 1; // 120ç§’å·¦å³åˆ¤æ–·ç‚º2åˆ†é˜
    }

    processBtn.addEventListener('click', async () => {
        const files = fileInput.files;
        statusDiv.innerHTML = 'â³ æ­£åœ¨åˆ†ææ•¸æ“šçµæ§‹èˆ‡æ—¥æœŸ...';
        processBtn.disabled = true;

        try {
            globalHeader = [];
            let combinedData = [];

            for (let i = 0; i < files.length; i++) {
                const sheets = await readAllSheetsData(files[i]);
                
                sheets.forEach((sheetData, sIdx) => {
                    let sheetDate = "Unknown";
                    if (sheetData[19] && sheetData[19][1]) {
                        const rawDate = String(sheetData[19][1]);
                        const dateMatch = rawDate.match(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/);
                        sheetDate = dateMatch ? dateMatch[0].replace(/\//g, "-") : rawDate.trim();
                    }

                    if (i === 0 && sIdx === 0) {
                        globalHeader = sheetData.slice(0, 22);
                    }

                    if (sheetData.length > 22) {
                        const body = sheetData.slice(22);
                        const interval = detectInterval(body);
                        
                        body.forEach(row => {
                            if (row[0]) {
                                combinedData.push({
                                    date: sheetDate,
                                    time: String(row[0]).trim(),
                                    interval: interval, // å„²å­˜è¾¨è­˜å‡ºçš„é–“éš”
                                    rawRow: row
                                });
                            }
                        });
                    }
                });
            }

            const uniqueMap = new Map();
            combinedData.forEach(item => {
                // key åŠ å…¥ interval ç¢ºä¿ 1åˆ†é˜èˆ‡ 2åˆ†é˜è³‡æ–™ä¸æœƒäº’ç›¸è¦†è“‹
                const compositeKey = `${item.date}_${item.interval}_${item.time}`;
                if (!uniqueMap.has(compositeKey)) {
                    uniqueMap.set(compositeKey, item);
                }
            });

            const sortedList = Array.from(uniqueMap.values()).sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                if (a.interval !== b.interval) return a.interval - b.interval;
                return a.time.localeCompare(b.time, undefined, {numeric: true});
            });

            globalBodyWithDate = sortedList;
            renderEnhancedPreview(sortedList.slice(0, 2000));
            
            statusDiv.className = 'success';
            const dateList = [...new Set(sortedList.map(i => i.date))];
            const intervalList = [...new Set(sortedList.map(i => i.interval + "åˆ†é˜"))];
            statusDiv.innerHTML = `âœ… å½™æ•´æˆåŠŸï¼æ—¥æœŸï¼š${dateList.join(", ")}ï¼ŒåŒ…å«é–“éš”ï¼š${intervalList.join("ã€")}ã€‚`;
            downloadBtn.style.display = 'block';
            previewContainer.style.display = 'block';
        } catch (error) {
            console.error(error);
            statusDiv.className = 'error';
            statusDiv.innerHTML = 'âŒ è™•ç†å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚';
        } finally {
            processBtn.disabled = false;
        }
    });

    downloadBtn.addEventListener('click', async () => {
        const sortedData = globalBodyWithDate;
        const allDates = [...new Set(sortedData.map(i => i.date))].sort();
        
        const formatFileNameDate = (dateStr) => {
            const clean = dateStr.replace(/[^0-9]/g, "");
            return clean.length >= 8 ? clean.substring(4) : clean;
        };

        const dateRangeStr = allDates.length > 1 
            ? `${formatFileNameDate(allDates[0])}-${formatFileNameDate(allDates[allDates.length-1])}`
            : (allDates[0] ? formatFileNameDate(allDates[0]) : "Report");

        let downloadCount = 0;

        // æ™‚æ®µè¿´åœˆ
        for (const slot of timeSlots) {
            // æ™‚æ®µå…§è³‡æ–™
            const slotData = sortedData.filter(item => item.time >= slot.start && item.time <= slot.end);
            if (slotData.length === 0) continue;

            // åˆ†é–‹è™•ç† 1 åˆ†é˜èˆ‡ 2 åˆ†é˜
            const availableIntervals = [...new Set(slotData.map(item => item.interval))];
            
            for (const inv of availableIntervals) {
                const invData = slotData.filter(item => item.interval === inv);
                const wb = XLSX.utils.book_new();
                const datesInSlot = [...new Set(invData.map(item => item.date))].sort();
                
                datesInSlot.forEach(targetDate => {
                    const dayRows = invData
                        .filter(item => item.date === targetDate)
                        .map(item => item.rawRow);
                    
                    const sheetContent = globalHeader.concat(dayRows);
                    const ws = XLSX.utils.aoa_to_sheet(sheetContent);
                    XLSX.utils.book_append_sheet(wb, ws, targetDate.slice(-10));
                });

                XLSX.writeFile(wb, `${dateRangeStr} ${slot.label}${inv}åˆ†é˜.xlsx`);
                downloadCount++;
                await new Promise(r => setTimeout(r, 450));
            }
        }
        statusDiv.innerHTML = `âœ… ä¸‹è¼‰å®Œæˆï¼å…±ç”¢ç”Ÿ ${downloadCount} å€‹å ±è¡¨ã€‚`;
    });

    function renderEnhancedPreview(sortedDataItems) {
        previewTable.innerHTML = '';
        globalHeader.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.className = 'header-row';
            const dateTd = document.createElement('td');
            dateTd.textContent = "-";
            tr.appendChild(dateTd);
            row.slice(0, 10).forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell !== undefined ? cell : "";
                tr.appendChild(td);
            });
            previewTable.appendChild(tr);
        });

        sortedDataItems.forEach(item => {
            const tr = document.createElement('tr');
            const infoTd = document.createElement('td');
            infoTd.className = 'date-col';
            infoTd.innerHTML = `${item.date}<br><small>(${item.interval}min)</small>`;
            tr.appendChild(infoTd);
            item.rawRow.slice(0, 10).forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell !== undefined ? cell : "";
                tr.appendChild(td);
            });
            previewTable.appendChild(tr);
        });
    }

    function readAllSheetsData(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const result = [];
                    workbook.SheetNames.forEach(name => {
                        const sheet = workbook.Sheets[name];
                        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                        if (data.length > 0) result.push(data);
                    });
                    resolve(result);
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }
</script>

</body>
</html>
